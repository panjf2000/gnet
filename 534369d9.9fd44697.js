(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{177:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return c})),n.d(t,"metadata",(function(){return i})),n.d(t,"rightToc",(function(){return b})),n.d(t,"default",(function(){return p}));var r=n(1),a=n(9),o=(n(0),n(251)),c={last_modified_on:"2022-02-27",id:"announcing-gnet-v2",title:"Announcing gnet v2.0.0",description:"Hello World! We present you, gnet v2.0.0!",author_github:"https://github.com/panjf2000",tags:["type: announcement","domain: presentation"]},i={permalink:"/blog/announcing-gnet-v2",source:"@site/blog/2022-02-27-announcing-gnet-v2.md",description:"Hello World! We present you, gnet v2.0.0!",date:"2022-02-27T00:00:00.000Z",tags:[{label:"type: announcement",permalink:"/blog/tags/type-announcement"},{label:"domain: presentation",permalink:"/blog/tags/domain-presentation"}],title:"Announcing gnet v2.0.0",readingTime:3.685,truncated:!1,prevItem:{title:"Announcing gnet v2.3.0",permalink:"/blog/announcing-gnet-v2-3-0"},nextItem:{title:"\u5b98\u5ba3 gnet v1.0.0",permalink:"/blog/announcing-gnet-v1-cn"}},b=[{value:"Features",id:"features",children:[]},{value:"Optimizations",id:"optimizations",children:[]},{value:"Performance",id:"performance",children:[{value:"Environment",id:"environment",children:[]}]}],l={rightToc:b};function p(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Today, I'm thrilled to announce the release of ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/panjf2000/gnet/releases/tag/v2.0.0"}),"gnet v2.0.0"),", in which we've made plenty of significant improvements and optimizations: added and removed some APIs, redesigned and reimplemented the buffer, optimized the memory pool, etc."),Object(o.b)("p",null,"In this blog post, we'll go through the most notable changes to gnet 2.0."),Object(o.b)("p",null,"P.S. Follow me on Twitter ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://twitter.com/panjf2000"}),"@panjf2000")," to get the latest updates about gnet!"),Object(o.b)("h2",{id:"features"},"Features"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"The built-in codecs have been deprecated and removed, to reduce the complexity and keep gnet simple. From a lot of feedback we've received, this feature does not bring convenience and benefits to users, thus, I decided to take it off from gnet. Cutting those codecs off makes the code on top of gnet more holistic and straightforward, see a ",Object(o.b)("a",Object(r.a)({parentName:"li"},{href:"https://github.com/gnet-io/gnet-examples/tree/v2/simple_protocol"}),"simple example")," for details."),Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"gnet.Conn")," now implements ",Object(o.b)("inlineCode",{parentName:"li"},"io.Reader"),", ",Object(o.b)("inlineCode",{parentName:"li"},"io.Writer"),", ",Object(o.b)("inlineCode",{parentName:"li"},"io.ReaderFrom"),", ",Object(o.b)("inlineCode",{parentName:"li"},"io.WriterTo")," and ",Object(o.b)("inlineCode",{parentName:"li"},"net.Conn"),", apart from that, it also implements the ",Object(o.b)("inlineCode",{parentName:"li"},"gnet.Socket")," interface, providing more API's for users to manipulate the connections."),Object(o.b)("li",{parentName:"ul"},"gnet now supports vectored I/O, allowing users to read from a vector of buffers and write to a single data stream, a vectored I/O implementation can provide improved performance over a linear I/O implementation via internal optimizations. API's for vectored I/O in gnet are ",Object(o.b)("inlineCode",{parentName:"li"},"Conn.Writev([][]byte)")," and ",Object(o.b)("inlineCode",{parentName:"li"},"Conn.AsyncWritev([][]byte, AsyncCallback)"),".")),Object(o.b)("p",null,"Visit ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://pkg.go.dev/github.com/panjf2000/gnet@v2.0.0"}),"gnet API doc")," for more details."),Object(o.b)("p",null,"Note that some event handlers' name has been changed in gnet v2, learn about the details in the table below:"),Object(o.b)("table",null,Object(o.b)("thead",{parentName:"table"},Object(o.b)("tr",{parentName:"thead"},Object(o.b)("th",Object(r.a)({parentName:"tr"},{align:"center"}),"Old event handler"),Object(o.b)("th",Object(r.a)({parentName:"tr"},{align:"center"}),"New event handler"),Object(o.b)("th",Object(r.a)({parentName:"tr"},{align:"center"}),"Note"))),Object(o.b)("tbody",{parentName:"table"},Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnInitComplete"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnBoot"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}))),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnShutdown"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnShutdown"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}))),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnOpened"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnOpen"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}))),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnClosed"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnClose"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}))),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"React"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnTraffic"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}))),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"Tick"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"OnTick"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}))),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"PreWrite"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"-"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"Deprecated")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"AfterWrite"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"-"),Object(o.b)("td",Object(r.a)({parentName:"tr"},{align:"center"}),"Deprecated")))),Object(o.b)("h2",{id:"optimizations"},"Optimizations"),Object(o.b)("p",null,"We redesigned and reimplemented the internal buffers for connections, the diagram shows below:"),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"https://res.strikefreedom.top/static_res/blog/figures/elastic-buffer.png",alt:null}))),Object(o.b)("p",null,"We go from the ring-buffer to the mixed-buffer that combines ring-buffer and a kind of new buffer type: linked-list buffer, which makes it more flexible and efficient, this new elastic buffer can save more memory."),Object(o.b)("h2",{id:"performance"},"Performance"),Object(o.b)("p",null,"We've run a simple echo benchmark on Linux between v1.5.3 and v2.0.0, the results are shown below\uff1a"),Object(o.b)("h3",{id:"environment"},"Environment"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-powershell"}),"# Machine information\n        OS : Ubuntu 20.04/x86_64\n       CPU : 8 CPU cores, AMD EPYC 7K62 48-Core Processor\n    Memory : 16.0 GiB\n\n# Go version and settings\nGo Version : go1.17.2 linux/amd64\nGOMAXPROCS : 8\n\n# Benchmark parameters\nTCP connections : 1000\nPacket size     : 1024 bytes\nTest duration   : 15s\n")),Object(o.b)("h4",{id:"v153"},"v1.5.3"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-bash"}),"--- GNET ---\n\nWarming up for 1 seconds...\n2022/02/27 17:23:21 Echo server is listening on 127.0.0.1:7002 (multi-cores: true, event-loops: 8)\n\n--- BENCHMARK START ---\n*** 1000 connections, 15 seconds, packet size: 1024 bytes\n\nFortio dev running at 0 queries per second, 8->8 procs, for 15s: tcp://127.0.0.1:7002\nAggregated Function Time : count 5795008 avg 0.0025874045 +/- 0.003243 min 1.1692e-05 max 0.093107062 sum 14994.0299\n# target 50% 0.00169983\n# target 75% 0.00399017\n# target 90% 0.00655109\n# target 99% 0.0141534\n# target 99.9% 0.0266069\nSockets used: 1000 (for perfect no error run, would be 1000)\nTotal Bytes sent: 5935112192, received: 5935112192\ntcp OK : 5795008 (100.0 %)\nAll done 5795008 calls (plus 1000 warmup) 2.587 ms avg, 386287.8 qps\n")),Object(o.b)("h4",{id:"v200"},"v2.0.0"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-bash"}),"--- GNET ---\n\nWarming up for 1 seconds...\n2022/02/27 17:17:32 echo server with multi-core=true is listening on tcp://:7002\n\n--- BENCHMARK START ---\n*** 1000 connections, 15 seconds, packet size: 1024 bytes\n\nFortio dev running at 0 queries per second, 8->8 procs, for 15s: tcp://127.0.0.1:7002\nAggregated Function Time : count 6729707 avg 0.0022276692 +/- 0.00317 min 1.1902e-05 max 0.07715059 sum 14991.5608\n# target 50% 0.00132464\n# target 75% 0.00241054\n# target 90% 0.00502497\n# target 99% 0.016105\n# target 99.9% 0.0291019\nSockets used: 1000 (for perfect no error run, would be 1000)\nTotal Bytes sent: 6892243968, received: 6892243968\ntcp OK : 6729707 (100.0 %)\nAll done 6729707 calls (plus 1000 warmup) 2.228 ms avg, 448593.2 qps\n")),Object(o.b)("p",null,"The result shows that the performance of v2 is improved by about 16% compared to v1.x."),Object(o.b)("p",null,"Note that this is only a rough benchmark test result and it is done with the simple protocol -- echo, besides, with the benefits from vectored I/O, the performance ought to achieve even higher when it comes to some more complex scenarios, later we will do a more comprehensive benchmark test to get some more accurate results."))}p.isMDXComponent=!0},251:function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return u}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function b(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),p=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i({},t,{},e)),n},s=function(e){var t=p(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=Object(r.forwardRef)((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,l=b(e,["components","mdxType","originalType","parentName"]),s=p(n),d=r,u=s["".concat(c,".").concat(d)]||s[d]||m[d]||o;return n?a.a.createElement(u,i({ref:t},l,{components:n})):a.a.createElement(u,i({ref:t},l))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,c=new Array(o);c[0]=d;var i={};for(var b in t)hasOwnProperty.call(t,b)&&(i[b]=t[b]);i.originalType=e,i.mdxType="string"==typeof e?e:r,c[1]=i;for(var l=2;l<o;l++)c[l]=n[l];return a.a.createElement.apply(null,c)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);